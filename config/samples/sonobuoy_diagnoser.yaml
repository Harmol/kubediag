apiVersion: diagnosis.kubediag.org/v1
kind: Operation
metadata:
  name: sonobuoy-script
spec:
  processor:
    scriptRunner:
      script: |
        #!/usr/bin/env bash
        FILE=/usr/bin/sonobuoy
        if [ -f "$FILE" ]; then 
          echo "$FILE exists"
        else
          wget --quiet https://sonobuoy.nos-eastchina1.126.net/sonobuoy_0.51.0_linux_amd64.tar.gz
          tar -xvf sonobuoy_0.51.0_linux_amd64.tar.gz
          mv sonobuoy /usr/bin
        fi

        sonobuoy delete --wait

        cat <<EOF> repo.yaml
        buildImageRegistry: hub.c.163.com/kubediag/build-image
        dockerGluster: hub.c.163.com/kubediag/gluster
        dockerLibraryRegistry: hub.c.163.com/kubediag/library
        e2eRegistry: hub.c.163.com/kubediag/kubernetes-e2e-test-images
        e2eVolumeRegistry: hub.c.163.com/kubediag/kubernetes-e2e-test-images/volume
        gcRegistry: hub.c.163.com/kubediag
        gcEtcdRegistry: hub.c.163.com/kubediag
        promoterE2eRegistry: hub.c.163.com/kubediag/e2e-test-images
        sigStorageRegistry: hub.c.163.com/kubediag/sig-storage
        EOF

        sonobuoy run --sonobuoy-image sonobuoy/sonobuoy:v0.51.0 --kube-conformance-image hub.c.163.com/kubediag/conformance:v1.19.16 --systemd-logs-image hub.c.163.com/kubediag/systemd-logs:v0.3 --e2e-repo-config repo.yaml --wait

        # don't edit following code.
        DIR=/var/lib/kubediag/results
        if [ ! -d "$DIR" ]; then
          mkdir $DIR
        fi
        cd $DIR
        results=$(sonobuoy retrieve)
        tar -xvf $results

        sonobuoy results $results --mode dump --plugin e2e > results_dump_e2e.yaml
        sonobuoy results $results --mode dump --plugin sonobuoy > results_dump_sonobuoy.yaml
        
        sonobuoy delete --wait
      argKeys:
      - param.operation.sonobuoy.path
      operationResultKey: "sonobuoy"
    timeoutSeconds: 18000
---
apiVersion: diagnosis.kubediag.org/v1
kind: Operation
metadata:
  name: sonobuoy-results
spec:
  processor:
    httpServer:
      path: /processor/sonobuoyResultsDiagnoser
      scheme: http
    timeoutSeconds: 60
---
apiVersion: diagnosis.kubediag.org/v1
kind: OperationSet
metadata:
  name: sonobuoy
spec:
  adjacencyList:
  - id: 0
    to:
    - 1
  - id: 1
    operation: sonobuoy-script
    to:
    - 2
  - id: 2
    operation: sonobuoy-results
---
apiVersion: diagnosis.kubediag.org/v1
kind: Diagnosis
metadata:
  name: sonobuoy
spec: 
  operationSet: sonobuoy
  nodeName: my-node
  parameters:
    "param.operation.sonobuoy.path": "/var/lib/kubediag"
    "param.diagnoser.kubernetes.sonobuoy_results_diagnoser.expiration_seconds": "60"
    "param.diagnoser.kubernetes.sonobuoy_results_diagnoser.results_dir": "var/lib/kubediag/results"
    "param.diagnoser.kubernetes.sonobuoy_results_diagnoser.plugin_e2e_file": "results_dump_e2e.yaml"
    "param.diagnoser.kubernetes.sonobuoy_results_diagnoser.plugin_sonobuoy_file": "results_dump_sonobuoy.yaml"
